<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üè† Frans Vastgoed Analyse Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&family=Mulish:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary:#800000;
      --primary-dark:#5a0000;
      --bg:#faf7f4;
      --card:#ffffff;
      --text:#1f1f1f;
      --text-muted:#666666;
      --border:#eadfd6;
      --shadow:0 8px 30px rgba(0,0,0,.06);
      --radius:16px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Mulish, Arial, sans-serif;
      line-height:1.8em;
      color:var(--text);
      background:linear-gradient(180deg,#fff, var(--bg));
    }

    h1,h2,h3{
      font-family:Poppins, Arial, sans-serif;
      color:var(--primary);
      line-height:1.35em;
    }

    .ifr-wrap{
      max-width:1100px;
      margin:0 auto;
      padding:32px 18px 60px;
    }

    .ifr-header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:18px;
      margin-bottom:18px;
    }

    .ifr-title{
      margin:0;
      font-size:28px;
    }

    .ifr-subtitle{
      margin:6px 0 0;
      color:var(--text-muted);
      font-size:14px;
    }

    .ifr-card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:22px;
    }

    .ifr-search{
      display:flex;
      gap:10px;
      align-items:center;
    }

    .ifr-search input{
      flex:1;
      padding:12px 14px;
      border:1px solid var(--border);
      border-radius:12px;
      font-size:15px;
      outline:none;
    }

    .ifr-search input:focus{
      border-color:rgba(128,0,0,.45);
      box-shadow:0 0 0 4px rgba(128,0,0,.08);
    }

    .ifr-btn{
      padding:12px 14px;
      border:0;
      border-radius:12px;
      background:var(--primary);
      color:#fff;
      font-weight:700;
      cursor:pointer;
      transition:transform .05s ease, background .2s ease;
    }
    .ifr-btn:hover{background:var(--primary-dark)}
    .ifr-btn:active{transform:translateY(1px)}

    .ifr-kpis{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:12px;
      margin-top:16px;
    }
    @media (max-width: 980px){
      .ifr-kpis{grid-template-columns:repeat(2,1fr)}
    }

    .ifr-kpi{
      padding:14px 14px 12px;
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
    }
    .ifr-kpi-label{font-size:12px;color:var(--text-muted);margin-bottom:6px}
    .ifr-kpi-value{font-size:18px;font-weight:800}
    .ifr-kpi-note{font-size:12px;color:var(--text-muted);margin-top:4px}

    .ifr-tabs{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:18px;
    }

    .ifr-tab{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
      user-select:none;
    }
    .ifr-tab.active{
      background:rgba(128,0,0,.08);
      border-color:rgba(128,0,0,.35);
      color:var(--primary);
    }

    .ifr-panel{margin-top:14px}
    .ifr-panel.hidden{display:none}

    .ifr-empty{
      text-align:center;
      padding:28px 10px;
      color:var(--text-muted);
    }
    .ifr-empty-icon{font-size:30px;margin-bottom:10px}

    .ifr-table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    .ifr-table th,.ifr-table td{
      padding:10px 10px;
      border-bottom:1px solid var(--border);
      text-align:left;
      vertical-align:top;
    }
    .ifr-table th{
      font-family:Poppins, Arial, sans-serif;
      color:var(--primary);
      font-size:12px;
      letter-spacing:.02em;
    }
    .right{text-align:right}

    .badge{
      display:inline-block;
      padding:4px 8px;
      border-radius:999px;
      font-size:12px;
      font-weight:800;
      background:rgba(128,0,0,.08);
      color:var(--primary);
      border:1px solid rgba(128,0,0,.18);
    }

    .risk-pill{
      display:inline-block;
      padding:3px 8px;
      border-radius:999px;
      font-size:12px;
      font-weight:800;
      border:1px solid var(--border);
      background:#fff;
    }
    .risk-pill.low{background:#f1fbf2;border-color:#cfe9d2;color:#166534}
    .risk-pill.medium{background:#fff7ed;border-color:#fed7aa;color:#9a3412}
    .risk-pill.high{background:#fef2f2;border-color:#fecaca;color:#991b1b}

    /* [i] Info blok */
    .infoBox{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding:12px 12px;
      background:var(--bg);
      border:1px solid var(--border);
      border-left:4px solid var(--primary);
      border-radius:12px;
      font-size:13px;
      color:#444;
      margin:12px 0;
    }
    .infoIcon{
      width:26px;
      height:26px;
      min-width:26px;
      border-radius:999px;
      background:rgba(128,0,0,.10);
      border:1px solid rgba(128,0,0,.18);
      color:var(--primary);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      line-height:1;
      font-family:Poppins, Arial, sans-serif;
    }
    .infoBox p{margin:0}
    .infoBox a{color:var(--primary);font-weight:700;text-decoration:underline}
  </style>
</head>

<body>
  <div class="ifr-wrap">

    <div class="ifr-header">
      <div>
        <h1 class="ifr-title">üè† Frans Vastgoed Analyse Dashboard</h1>
        <p class="ifr-subtitle">Offici√´le Franse data (DVF, G√©oRisques, IGN, GPU, ADEME/ARCEP) samengebracht voor Nederlandse kopers.</p>
      </div>
      <div style="text-align:right;min-width:220px">
        <span class="badge">Live</span>
        <div style="font-size:12px;color:var(--text-muted);margin-top:6px" id="nowDate">‚Äî</div>
      </div>
    </div>

    <div class="ifr-card">
      <h2 style="margin:0 0 10px;font-size:18px">Adres opzoeken (BAN)</h2>
      <div class="ifr-search">
        <input id="q" placeholder="Typ een adres in Frankrijk (straat, postcode, plaats)..." autocomplete="off" />
        <button class="ifr-btn" id="btnSearch">Zoek</button>
      </div>
      <div id="suggestions" style="margin-top:10px"></div>

      <div class="ifr-kpis">
        <div class="ifr-kpi">
          <div class="ifr-kpi-label">Transacties</div>
          <div class="ifr-kpi-value" id="kpiTx">‚Äî</div>
          <div class="ifr-kpi-note">Straal 5km, DVF 2025</div>
        </div>
        <div class="ifr-kpi">
          <div class="ifr-kpi-label">Gem. prijs/m¬≤</div>
          <div class="ifr-kpi-value" id="kpiAvgPrice">‚Äî</div>
          <div class="ifr-kpi-note">Indicatief op basis DVF</div>
        </div>
        <div class="ifr-kpi">
          <div class="ifr-kpi-label">Risico‚Äôs</div>
          <div class="ifr-kpi-value" id="kpiRisk">‚Äî</div>
          <div class="ifr-kpi-note">G√©oRisques</div>
        </div>
        <div class="ifr-kpi">
          <div class="ifr-kpi-label">PLU / GPU</div>
          <div class="ifr-kpi-value" id="kpiPLU">‚Äî</div>
          <div class="ifr-kpi-note">G√©oportail Urbanisme</div>
        </div>
      </div>

      <div class="ifr-tabs">
        <div class="ifr-tab active" data-tab="overzicht">Overzicht</div>
        <div class="ifr-tab" data-tab="transacties">Transacties</div>
        <div class="ifr-tab" data-tab="risicos">Risico‚Äôs</div>
        <div class="ifr-tab" data-tab="kadaster">Kadaster</div>
        <div class="ifr-tab" data-tab="energie">Energie</div>
      </div>

      <div class="ifr-panel" id="panel-overzicht">
        <div id="overzichtContent" class="ifr-card" style="margin-top:14px">
          <div class="ifr-empty">
            <div class="ifr-empty-icon">üß≠</div>
            <p>Zoek een adres om offici√´le data en links te tonen.</p>
          </div>
        </div>
      </div>

      <div class="ifr-panel hidden" id="panel-transacties">
        <div class="ifr-card" style="margin-top:14px">
          <h2 style="margin:0 0 6px;font-size:18px">Transacties (DVF)</h2>
          <p class="ifr-subtitle">Bron: Demandes de Valeurs Fonci√®res ‚Äî notari√´le aktes binnen 5km</p>
          <div id="transactiesContent"></div>
        </div>
      </div>

      <div class="ifr-panel hidden" id="panel-risicos">
        <div class="ifr-card" style="margin-top:14px">
          <h2 style="margin:0 0 6px;font-size:18px">Risico‚Äôs (G√©oRisques)</h2>
          <p class="ifr-subtitle">Overstroming, radon, seismisch, klei, SEVESO, enz.</p>
          <div id="risicosContent"></div>
        </div>
      </div>

      <div class="ifr-panel hidden" id="panel-kadaster">
        <div class="ifr-card" style="margin-top:14px">
          <h2 style="margin:0 0 6px;font-size:18px">Kadaster / PLU zone</h2>
          <p class="ifr-subtitle">Perceel, section, gemeente, GPU/PLU waar beschikbaar</p>
          <div id="kadasterContent"></div>
        </div>
      </div>

      <div class="ifr-panel hidden" id="panel-energie">
        <div class="ifr-card" style="margin-top:14px">
          <h2 style="margin:0 0 6px;font-size:18px">Energie & internet</h2>
          <p class="ifr-subtitle">DPE context + ARCEP dekking (glasvezel/mobiel)</p>
          <div id="energieContent"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // =============================
    // Helpers / State
    // =============================
    const now = new Date();
    document.getElementById('nowDate').textContent = now.toLocaleDateString('nl-NL', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

    const debounce = (fn, ms) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; };

    const getRiskClass = (n) => ({ tres_faible: 'low', faible: 'low', moyen: 'medium', fort: 'high', tres_fort: 'high' }[n] || 'medium');

    const state = {
      location: null,
      data: { dvf: null, risques: null, cadastre: null, urbanisme: null, dpe: null }
    };

    const API = {
      ban: 'https://api-adresse.data.gouv.fr',
      dvf: '/api/dvf',
      risques: '/api/risques',
      cadastre: '/api/cadastre',
      urbanisme: '/api/urbanisme',
      dpe: '/api/dpe'
    };

    const DVF_YEAR = 2025;
    const DVF_RADIUS_KM = 5;
    const DVF_SOURCE_NOTE = "DVF 2025 (alternatieve API; offici√´le overheid-API onbetrouwbaar)";

    // =============================
    // Tabs
    // =============================
    document.querySelectorAll('.ifr-tab').forEach(t => {
      t.addEventListener('click', () => {
        document.querySelectorAll('.ifr-tab').forEach(x => x.classList.remove('active'));
        t.classList.add('active');

        const tab = t.getAttribute('data-tab');
        document.querySelectorAll('.ifr-panel').forEach(p => p.classList.add('hidden'));
        document.getElementById(`panel-${tab}`).classList.remove('hidden');

        if (state.location) {
          if (tab === 'overzicht') renderOverzicht();
          if (tab === 'transacties') renderTransacties();
          if (tab === 'risicos') renderRisicos();
          if (tab === 'kadaster') renderKadaster();
          if (tab === 'energie') renderEnergie();
        }
      });
    });

    // =============================
    // BAN Search
    // =============================
    const q = document.getElementById('q');
    const suggestions = document.getElementById('suggestions');
    const btnSearch = document.getElementById('btnSearch');

    async function searchBAN(query) {
      const r = await fetch(`${API.ban}/search/?q=${encodeURIComponent(query)}&limit=6`);
      const j = await r.json();
      return j.features || [];
    }

    function renderSuggestions(features) {
      if (!features.length) {
        suggestions.innerHTML = `<div style="padding:10px 0;color:var(--text-muted)">Geen resultaten.</div>`;
        return;
      }
      suggestions.innerHTML = `
        <div style="display:grid;gap:8px;margin-top:8px">
          ${features.map(f => `
            <button class="ifr-btn" style="text-align:left;background:#fff;color:var(--text);border:1px solid var(--border);font-weight:600"
              onclick='selectAddress(${JSON.stringify(f).replace(/'/g,"&#39;")})'>
              ${f.properties.label}
              <div style="font-size:12px;color:var(--text-muted);font-weight:400">INSEE: ${f.properties.citycode || '‚Äî'} ‚Ä¢ Score: ${Math.round((f.properties.score||0)*100)/100}</div>
            </button>
          `).join('')}
        </div>
      `;
    }

    const doSuggest = debounce(async () => {
      const v = q.value.trim();
      if (v.length < 5) { suggestions.innerHTML = ''; return; }
      try{
        const features = await searchBAN(v);
        renderSuggestions(features);
      }catch(e){
        suggestions.innerHTML = `<div style="padding:10px 0;color:var(--text-muted)">Zoeken mislukt. Probeer opnieuw.</div>`;
      }
    }, 250);

    q.addEventListener('input', doSuggest);
    btnSearch.addEventListener('click', async () => {
      const v = q.value.trim();
      if (v.length < 5) return;
      const features = await searchBAN(v);
      renderSuggestions(features);
    });

    window.selectAddress = async function(f){
      state.location = f;
      suggestions.innerHTML = '';
      q.value = f.properties.label;

      await fetchAllForLocation();
      renderOverzicht();
    }

    // =============================
    // Fetch data
    // =============================
    async function fetchAllForLocation(){
      const [lon, lat] = state.location.geometry.coordinates;
      const code_insee = state.location.properties.citycode;

      ['kpiTx','kpiAvgPrice','kpiRisk','kpiPLU'].forEach(id => document.getElementById(id).textContent = '...');

      await Promise.all([
        fetchDVF(lat, lon),
        fetchRisques(lat, lon, code_insee),
        fetchCadastre(lat, lon),
        fetchUrbanisme(lat, lon),
        fetchDPE(lat, lon)
      ]);

      updateKPIs();
    }

    async function fetchDVF(lat, lon) {
      try {
        const r = await fetch(`${API.dvf}?lat=${lat}&lon=${lon}&radius=${DVF_RADIUS_KM}`);
        state.data.dvf = await r.json();
      } catch (e) {
        state.data.dvf = { transactions: [], error: true };
      }
    }

    async function fetchRisques(lat, lon, code_insee) {
      try {
        const r = await fetch(`${API.risques}?lat=${lat}&lon=${lon}&code_insee=${code_insee}`);
        state.data.risques = await r.json();
      } catch (e) {
        state.data.risques = { error: true };
      }
    }

    async function fetchCadastre(lat, lon) {
      try {
        const r = await fetch(`${API.cadastre}?lat=${lat}&lon=${lon}`);
        state.data.cadastre = await r.json();
      } catch (e) {
        state.data.cadastre = { error: true };
      }
    }

    async function fetchUrbanisme(lat, lon) {
      try {
        const r = await fetch(`${API.urbanisme}?lat=${lat}&lon=${lon}`);
        state.data.urbanisme = await r.json();
      } catch (e) {
        state.data.urbanisme = { error: true };
      }
    }

    async function fetchDPE(lat, lon) {
      try {
        const r = await fetch(`${API.dpe}?lat=${lat}&lon=${lon}`);
        state.data.dpe = await r.json();
      } catch (e) {
        state.data.dpe = { error: true };
      }
    }

    // =============================
    // KPIs
    // =============================
    function updateKPIs(){
      const txs = state.data.dvf?.transactions || [];
      document.getElementById('kpiTx').textContent = txs.length ? String(txs.length) : '0';

      const woningen = txs.filter(t => t.surface && (t.type === 'Maison' || t.type === 'Appartement'));
      const avg = woningen.length ? Math.round(woningen.reduce((s,t)=> s + (t.prix / t.surface), 0) / woningen.length) : null;
      document.getElementById('kpiAvgPrice').textContent = avg ? `${avg.toLocaleString('nl-NL')} ‚Ç¨` : '‚Äî';

      const risques = state.data.risques || {};
      const rCount = ['inondation','seisme','radon','argile','seveso'].filter(k => risques[k]).length;
      document.getElementById('kpiRisk').textContent = rCount ? String(rCount) : '‚Äî';

      const plu = state.data.urbanisme?.plu?.url || state.data.urbanisme?.gpu?.url;
      document.getElementById('kpiPLU').textContent = plu ? 'Ja' : '‚Äî';
    }

    // =============================
    // Render Overzicht
    // =============================
    function renderOverzicht() {
      const c = document.getElementById('overzichtContent');
      const f = state.location;

      const [lon, lat] = f.geometry.coordinates;
      const code_insee = f.properties.citycode || '';
      const commune = f.properties.city || '';
      const postcode = f.properties.postcode || '';

      const txs = state.data.dvf?.transactions || [];
      const avgM2 = (() => {
        const woningen = txs.filter(t => t.surface && (t.type === 'Maison' || t.type === 'Appartement'));
        if(!woningen.length) return null;
        return Math.round(woningen.reduce((s,t)=> s + (t.prix / t.surface), 0) / woningen.length);
      })();

      const links = [
        { label: 'G√©oRisques ‚Äî kaart & rapport', url: `https://www.georisques.gouv.fr/`, icon: '‚ö†Ô∏è' },
        { label: 'Cadastre ‚Äî kaart', url: `https://www.cadastre.gouv.fr/scpc/rechercherPlan.do`, icon: 'üó∫Ô∏è' },
        { label: 'G√©oportail Urbanisme ‚Äî PLU', url: `https://www.geoportail-urbanisme.gouv.fr/map/#/center/${lon}/${lat}/zoom/17`, icon: 'üèõÔ∏è' },
        { label: 'DVF Explorer ‚Äî Transacties', url: `https://explore.data.gouv.fr/immobilier?onglet=carte&lat=${lat}&lon=${lon}&zoom=16`, icon: 'üí∂' },
        { label: 'Observatoire DPE-AUDIT (ADEME)', url: `https://observatoire-dpe-audit.ademe.fr/`, icon: 'üè∑Ô∏è' },
        { label: 'ARCEP ‚Äî Ma Connexion Internet', url: `https://maconnexioninternet.arcep.fr/?lat=${lat}&lon=${lon}&zoom=17`, icon: 'üì∂' }
      ];

      c.innerHTML = `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
          <div style="padding:18px;border:1px solid var(--border);border-radius:14px;background:#fff">
            <h3 style="margin:0 0 10px;font-size:15px">üìç Adres</h3>
            <div style="font-family:monospace;background:var(--bg);padding:12px;border-radius:10px;border:1px solid var(--border);user-select:all">${f.properties.label}</div>
            <div style="margin-top:10px;font-size:13px;color:var(--text-muted)">
              Commune: <strong>${commune}</strong> ‚Ä¢ Postcode: <strong>${postcode}</strong> ‚Ä¢ INSEE: <strong>${code_insee}</strong><br>
              Co√∂rdinaten: <strong>${lat.toFixed(6)}, ${lon.toFixed(6)}</strong>
            </div>
          </div>

          <div style="padding:18px;border:1px solid var(--border);border-radius:14px;background:#fff">
            <h3 style="margin:0 0 10px;font-size:15px">üìä Snelle duiding</h3>
            <ul style="margin:0;padding-left:18px;font-size:13px">
              <li>DVF (2025): <strong>${txs.length}</strong> transacties binnen ${DVF_RADIUS_KM}km (${DVF_SOURCE_NOTE}).</li>
              <li>Gemiddeld (woningen met m¬≤): <strong>${avgM2 ? avgM2.toLocaleString('nl-NL') + ' ‚Ç¨/m¬≤' : '‚Äî'}</strong> (indicatief).</li>
              <li>Risico‚Äôs: kijk naar de tab ‚ÄúRisico‚Äôs‚Äù voor radon/klei/inondation/seismisch/SEVESO.</li>
              <li>PLU/GPU: check tab ‚ÄúKadaster‚Äù voor planologische bronlinks.</li>
            </ul>
          </div>
        </div>

        <div style="margin-top:16px;padding:16px;border-radius:14px;background:var(--bg);border:1px solid var(--border)">
          <h3 style="margin:0 0 10px;font-size:15px">üîó Direct naar offici√´le bronnen</h3>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px">
            ${links.map(l => `
              <a href="${l.url}" target="_blank" class="ifr-btn" style="background:#fff;color:var(--text);border:1px solid var(--border);font-weight:700;text-decoration:none;display:flex;align-items:center;gap:10px;justify-content:flex-start">
                <span style="font-size:18px">${l.icon}</span>
                <span style="line-height:1.3em">${l.label}</span>
              </a>
            `).join('')}
          </div>
        </div>
      `;
    }

    // =============================
    // Render Transacties
    // =============================
    function renderTransacties() {
      const c = document.getElementById('transactiesContent');
      const txs = state.data.dvf?.transactions || [];

      if (!txs.length) {
        c.innerHTML = `
          <div class="ifr-empty">
            <div class="ifr-empty-icon">üì≠</div>
            <p>Geen transacties gevonden binnen ${DVF_RADIUS_KM}km in ${DVF_YEAR}</p>
            <div class="infoBox" style="max-width:700px;margin:14px auto 0">
              <div class="infoIcon">i</div>
              <div>
                <p><strong>Beperking:</strong> ${DVF_SOURCE_NOTE}. In landelijke gebieden kan dit overzicht onvolledig zijn.</p>
              </div>
            </div>
          </div>
        `;
        return;
      }

      const woningen = txs.filter(t => t.surface && (t.type === 'Maison' || t.type === 'Appartement'));

      c.innerHTML = `
        <div class="infoBox" style="margin-top:12px">
          <div class="infoIcon">i</div>
          <div>
            <p><strong>${txs.length}</strong> transacties (${DVF_YEAR}); <strong>${woningen.length}</strong> woningen met oppervlakte. <span style="color:var(--text-muted)">${DVF_SOURCE_NOTE}.</span></p>
          </div>
        </div>

        <div style="overflow:auto;border:1px solid var(--border);border-radius:12px">
          <table class="ifr-table">
            <thead>
              <tr>
                <th>Datum</th>
                <th>Type</th>
                <th class="right">Prijs</th>
                <th class="right">m¬≤</th>
                <th class="right">‚Ç¨/m¬≤</th>
              </tr>
            </thead>
            <tbody>
              ${txs.slice(0, 25).map(t => {
                const ppm2 = t.surface ? Math.round(t.prix / t.surface) : null;
                const d = t.date ? new Date(t.date) : null;
                const dStr = d ? d.toLocaleDateString('nl-NL') : '‚Äî';
                return `
                  <tr>
                    <td>${dStr}</td>
                    <td><span class="badge">${t.type || '‚Äî'}</span></td>
                    <td class="right"><strong>${(t.prix || 0).toLocaleString('nl-NL')} ‚Ç¨</strong></td>
                    <td class="right">${t.surface ? t.surface : '‚Äî'}</td>
                    <td class="right">${ppm2 ? ppm2.toLocaleString('nl-NL') : '‚Äî'}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>

        ${txs.length > 25 ? `<p style="margin-top:12px;font-size:12px;color:var(--text-muted)">Toont 25 van ${txs.length} transacties</p>` : ''}
      `;
    }

    // =============================
    // Render Risico‚Äôs
    // =============================
    function renderRisicos(){
      const c = document.getElementById('risicosContent');
      const r = state.data.risques;

      if(!r || r.error){
        c.innerHTML = `
          <div class="ifr-empty">
            <div class="ifr-empty-icon">‚ö†Ô∏è</div>
            <p>Risico-data niet beschikbaar (API fout of limiet).</p>
            <a href="https://www.georisques.gouv.fr/" target="_blank" class="ifr-btn" style="margin-top:12px">Open G√©oRisques ‚Üí</a>
          </div>
        `;
        return;
      }

      const items = [
        { key:'inondation', label:'Overstroming', val:r.inondation },
        { key:'seisme', label:'Seismisch', val:r.seisme },
        { key:'radon', label:'Radon', val:r.radon },
        { key:'argile', label:'Klei (RGA)', val:r.argile },
        { key:'seveso', label:'SEVESO', val:r.seveso }
      ].filter(x => x.val);

      if(!items.length){
        c.innerHTML = `
          <div class="ifr-empty">
            <div class="ifr-empty-icon">‚úÖ</div>
            <p>Geen risico-indicatoren teruggekregen voor dit punt.</p>
            <a href="https://www.georisques.gouv.fr/" target="_blank" class="ifr-btn" style="margin-top:12px">Check op kaart ‚Üí</a>
          </div>
        `;
        return;
      }

      c.innerHTML = `
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;margin-top:12px">
          ${items.map(it => `
            <div style="padding:16px;border:1px solid var(--border);border-radius:14px;background:#fff">
              <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
                <strong>${it.label}</strong>
                <span class="risk-pill ${getRiskClass(it.val.niveau || it.val.level || it.val)}">${(it.val.niveau || it.val.level || it.val || '‚Äî')}</span>
              </div>
              <div style="margin-top:8px;font-size:13px;color:var(--text-muted)">
                ${it.val.detail || it.val.description || 'Zie offici√´le bron voor details.'}
              </div>
            </div>
          `).join('')}
        </div>

        <div style="margin-top:16px">
          <a class="ifr-btn" target="_blank" href="https://www.georisques.gouv.fr/" style="text-decoration:none">Open G√©oRisques ‚Üí</a>
        </div>
      `;
    }

    // =============================
    // Render Kadaster
    // =============================
    function renderKadaster(){
      const c = document.getElementById('kadasterContent');
      const cad = state.data.cadastre;
      const urb = state.data.urbanisme;

      const [lon, lat] = state.location.geometry.coordinates;

      c.innerHTML = `
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:16px;margin-top:12px">
          <div style="padding:18px;border:1px solid var(--border);border-radius:14px;background:#fff">
            <h3 style="margin:0 0 10px;font-size:15px;color:var(--primary)">üó∫Ô∏è Kadaster (IGN API Carto)</h3>
            ${(!cad || cad.error) ? `
              <div style="color:var(--text-muted);font-size:13px">Kadasterdata niet beschikbaar.</div>
            ` : `
              <div style="font-size:13px;color:var(--text-muted)">
                Commune: <strong>${cad.commune || '‚Äî'}</strong><br>
                INSEE: <strong>${cad.insee || '‚Äî'}</strong><br>
                Section: <strong>${cad.section || '‚Äî'}</strong><br>
                Parcel(en): <strong>${(cad.parcelles || []).join(', ') || '‚Äî'}</strong>
              </div>
            `}
            <a href="https://www.cadastre.gouv.fr/scpc/rechercherPlan.do" target="_blank" class="ifr-btn" style="margin-top:12px;text-decoration:none;display:inline-block">Open kadaster ‚Üí</a>
          </div>

          <div style="padding:18px;border:1px solid var(--border);border-radius:14px;background:#fff">
            <h3 style="margin:0 0 10px;font-size:15px;color:var(--primary)">üèõÔ∏è PLU / GPU</h3>
            ${(!urb || urb.error) ? `
              <div style="color:var(--text-muted);font-size:13px">Urbanisme-data niet beschikbaar.</div>
            ` : `
              <div style="font-size:13px;color:var(--text-muted)">
                ${urb.plu?.url ? `PLU-link: <a href="${urb.plu.url}" target="_blank">open</a><br>` : ''}
                ${urb.gpu?.url ? `GPU-link: <a href="${urb.gpu.url}" target="_blank">open</a><br>` : ''}
                ${(!urb.plu?.url && !urb.gpu?.url) ? 'Geen PLU/GPU-link teruggekregen (niet alle gemeenten hebben dekking via API).' : ''}
              </div>
            `}
            <a href="https://www.geoportail-urbanisme.gouv.fr/map/#/center/${lon}/${lat}/zoom/17" target="_blank" class="ifr-btn" style="margin-top:12px;text-decoration:none;display:inline-block">Open GPU kaart ‚Üí</a>
          </div>
        </div>
      `;
    }

    // =============================
    // Render Energie
    // =============================
    function renderEnergie() {
      const [lon, lat] = state.location.geometry.coordinates;
      const adres = state.location?.properties?.label || '';

      // Correcte links (Observatoire DPE-AUDIT + Service-Public ingang)
      const ADEME_OBS = "https://observatoire-dpe-audit.ademe.fr/";
      const SERVICE_PUBLIC_DPE = "https://www.service-public.gouv.fr/particuliers/vosdroits/R67366";

      document.getElementById('energieContent').innerHTML = `
        <div style="background: var(--bg); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
          <h3 style="margin: 0 0 8px; color: var(--primary); font-size: 16px;">üìç Geselecteerd adres</h3>
          <div style="font-family: monospace; background: #fff; padding: 12px; border-radius: 10px; border: 1px solid var(--border); user-select: all; font-size: 14px;">${adres}</div>
        </div>

        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px">
          <div style="padding:24px;border-radius:12px;border:2px solid var(--primary);background:#fff">
            <h3 style="margin:0 0 16px;font-size:15px;color:var(--primary)">üè∑Ô∏è Energielabel (DPE)</h3>

            <div style="display:flex;gap:3px;margin-bottom:16px">
              ${['A','B','C','D','E','F','G'].map((l,i)=>`<div style="flex:1;text-align:center;padding:6px 0;border-radius:6px;font-weight:800;background:${['#1b5e20','#2e7d32','#558b2f','#9e9d24','#f9a825','#ef6c00','#b71c1c'][i]};color:#fff;opacity:0.5">${l}</div>`).join('')}
            </div>

            <div class="infoBox">
              <div class="infoIcon">i</div>
              <div>
                <p><strong>Belangrijk:</strong> dit dashboard toont <strong>context</strong>. De exacte DPE van een pand staat in het offici√´le DPE-rapport van de verkoper.</p>
              </div>
            </div>

            <div class="infoBox">
              <div class="infoIcon">i</div>
              <div>
                <p><strong>Juridisch effect (DPE):</strong> vooral relevant voor <strong>verhuur</strong>.</p>
                <p>Label <strong>G</strong> verboden sinds <strong>01-01-2025</strong>; <strong>F</strong> vanaf <strong>01-01-2028</strong>; <strong>E</strong> vanaf <strong>01-01-2034</strong>.</p>
                <p><strong>Verkoop</strong> van F/G blijft toegestaan; w√©l kan een <em>audit √©nerg√©tique</em> verplicht zijn en speelt renovatie mee in de prijs.</p>
              </div>
            </div>

            <a href="${ADEME_OBS}" target="_blank" class="ifr-btn" style="width:100%;text-decoration:none;display:block;text-align:center;margin-bottom:8px">Observatoire DPE-AUDIT (ADEME) ‚Üí</a>
            <a href="${SERVICE_PUBLIC_DPE}" target="_blank" class="ifr-btn" style="width:100%;text-decoration:none;display:block;text-align:center;background:#fff;color:#800000;border:1px solid #800000;font-weight:700;font-size:13px">Service-Public: DPE verifi√´ren/attestation ‚Üí</a>

            <a href="https://france-renov.gouv.fr/" target="_blank" class="ifr-btn" style="width:100%;text-decoration:none;display:block;text-align:center;margin-top:10px;background:#fff;color:#800000;border:1px solid #800000;font-weight:700;font-size:13px">Renovatiepremies (France R√©nov‚Äô) ‚Üí</a>
          </div>

          <div style="padding:24px;border-radius:12px;border:1px solid #e0d6cc;background:#fff">
            <h3 style="margin:0 0 16px;font-size:15px;color:var(--primary)">üì∂ Internetdekking</h3>
            <div class="infoBox" style="margin-top:0">
              <div class="infoIcon">i</div>
              <div>
                <p>Controleer glasvezel & mobiel bereik via ARCEP.</p>
              </div>
            </div>
            <a href="https://maconnexioninternet.arcep.fr/?lat=${lat}&lon=${lon}&zoom=17" target="_blank" class="ifr-btn" style="width:100%;text-decoration:none;display:block;text-align:center;margin-bottom:8px">ARCEP: Ma Connexion Internet ‚Üí</a>
            <a href="https://monreseaumobile.arcep.fr/" target="_blank" class="ifr-btn" style="width:100%;text-decoration:none;display:block;text-align:center;background:#fff;color:#800000;border:1px solid #800000;font-weight:700;font-size:13px">ARCEP: Mon R√©seau Mobile ‚Üí</a>
          </div>
        </div>
      `;
    }
  </script>
</body>
</html>
